// Prisma Schema for ChartTalk.ai
// Handles conversation and message persistence

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/// Conversation (chat session) belonging to a user
model Conversation {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  title         String    @default("New Conversation") @db.VarChar(500)
  isPinned      Boolean   @default(false) @map("is_pinned")
  isArchived    Boolean   @default(false) @map("is_archived")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastMessageAt DateTime  @default(now()) @map("last_message_at")

  messages Message[]

  @@index([userId, lastMessageAt(sort: Desc)])
  @@index([userId, isArchived])
  @@map("conversations")
}

/// Message within a conversation
model Message {
  id             String       @id @default(uuid())
  conversationId String       @map("conversation_id")
  role           String       @db.VarChar(20) // 'user' | 'assistant'
  content        String       @db.Text

  // Legacy: Single chart reference (kept for backward compatibility)
  chartId        String?      @map("chart_id")
  chartUrl       String?      @map("chart_url") @db.VarChar(2000)
  chartSymbol    String?      @map("chart_symbol") @db.VarChar(50)
  chartInterval  String?      @map("chart_interval") @db.VarChar(10)

  // Multi-timeframe analysis result (JSON)
  mtfAnalysis    Json?        @map("mtf_analysis")

  // Token tracking for cost analysis
  tokensUsed     Int?         @map("tokens_used")

  createdAt      DateTime     @default(now()) @map("created_at")

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  charts         Chart[]      // Multiple charts for multi-timeframe analysis

  @@index([conversationId, createdAt])
  @@map("messages")
}

/// Chart generated for analysis (supports multi-timeframe)
model Chart {
  id             String       @id @default(uuid())
  messageId      String       @map("message_id")
  requestId      String       @map("request_id")

  // Chart identification
  symbol         String       @db.VarChar(50)  // e.g., 'BINANCE:BTCUSDT'
  interval       String       @db.VarChar(10)  // e.g., '4h', '1D'
  role           String?      @db.VarChar(10)  // 'htf' | 'etf' | 'ltf'

  // Image URLs
  imageUrl       String       @map("image_url") @db.VarChar(2000)
  s3Url          String?      @map("s3_url") @db.VarChar(2000)

  // Chart configuration (JSON)
  indicators     Json?        // Array of indicator names
  config         Json?        // Full ChartConfig object

  generatedAt    DateTime     @default(now()) @map("generated_at")

  message        Message      @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([requestId])
  @@map("charts")
}

/// User rate limiting for chart generation
/// Tracks daily chart usage per user with midnight UTC reset
model UserRateLimit {
  id         String   @id @default(uuid())
  userId     String   @unique @map("user_id")
  dailyCount Int      @default(0) @map("daily_count")
  lastReset  DateTime @default(now()) @map("last_reset")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("user_rate_limits")
}
